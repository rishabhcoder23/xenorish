<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XENORISH AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'] }, colors: { 'canvas-bg': '#f7f7f7', 'canvas-light': '#ffffff', 'canvas-border': '#e0e0e0', 'gemini-blue': '#4f46e5' } } } }
    </script>
    <style>
        html, body { height: 100%; margin: 0; display: flex; flex-direction: column; overflow: hidden; }
        #app-container { height: 100vh; height: -webkit-fill-available; display: flex; flex-direction: column; }
        .chat-window::-webkit-scrollbar { width: 8px; }
        .chat-window::-webkit-scrollbar-thumb { background-color: #d1d5db; border-radius: 4px; }
        .chat-window::-webkit-scrollbar-track { background-color: #f3f4f6; }
        .markdown-table { width: 100%; border-collapse: collapse; margin: 1rem 0; font-size: 0.875rem; }
        .markdown-table th, .markdown-table td { border: 1px solid #e5e7eb; padding: 0.5rem; text-align: left; }
        .markdown-table th { background-color: #f9fafb; font-weight: 600; }
        .status-badge { font-size: 0.75rem; padding: 2px 8px; border-radius: 9999px; font-weight: 600; transition: all 0.3s; }
        .toggle-switch { width: 40px; height: 20px; background-color: #e5e7eb; border-radius: 10px; position: relative; cursor: pointer; transition: background-color 0.3s; }
        .toggle-switch-checked { background-color: #10b981; }
        .toggle-switch-dot { position: absolute; top: 2px; left: 2px; width: 16px; height: 16px; background-color: white; border-radius: 50%; transition: transform 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .toggle-switch-dot-checked { transform: translateX(20px); }

        /* --- NEW ANIMATION CSS FOR 3 DOTS (used in the chat window) --- */
        .dot-pulse {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 4px 6px; /* Padding for the dots inside the bubble */
        }
        .dot-pulse > div {
            width: 8px;
            height: 8px;
            margin: 0 3px;
            background-color: #4f46e5; /* gemini-blue */
            border-radius: 50%;
            display: inline-block;
            animation: pulse 1.4s infinite ease-in-out both;
        }
        .dot-pulse > div:nth-child(1) {
            animation-delay: -0.32s;
        }
        .dot-pulse > div:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes pulse {
            0%, 80%, 100% {
                transform: scale(0.6);
                opacity: 0.7;
            }
            40% {
                transform: scale(1.0);
                opacity: 1.0;
            }
        }
        /* Style for the corner text - UPDATED FOR TOP RIGHT, CIRCLE, AND BLUE TEXT */
        .corner-text-tr {
            position: absolute;
            top: 50%;
            right: 1rem;
            transform: translateY(-50%);
            font-size: 0.7rem; 
            font-weight: 500;
            color: #4b5563; /* Default text color for "Created by" */
            white-space: nowrap;
            background-color: #e5e7eb; /* Light grey background for the circle */
            border-radius: 9999px; /* Makes it a circle/pill shape */
            padding: 0.25rem 0.75rem; /* Padding inside the circle */
            display: inline-flex; /* To make padding work correctly */
            align-items: center;
            justify-content: center;
        }
        /* Make the header relative for absolute positioning */
        .header-relative {
            position: relative;
        }
    </style>
</head>
<body class="font-sans bg-canvas-bg antialiased" id="app-container">
    <div class="flex flex-col h-screen w-full max-w-2xl mx-auto bg-canvas-light shadow-2xl rounded-xl overflow-hidden relative">
        <header class="p-4 bg-canvas-light text-gray-800 border-b border-canvas-border flex justify-between items-center flex-shrink-0 header-relative">
            <h1 class="text-xl md:text-2xl font-bold text-gray-700 flex items-center"><span class="text-2xl mr-2">ðŸ¤–</span>X.E.N.O.R.I.S.H.</h1>
            <div class="corner-text-tr">Created by<span class="text-gemini-blue">Rishabh</span></div>
        </header>
        <main id="chat-window" class="flex-grow overflow-y-scroll chat-window p-4 space-y-4 bg-canvas-bg">
            <div class="flex justify-start"><div class="max-w-md bg-canvas-light text-gray-800 p-3 rounded-xl shadow-sm border border-canvas-border"><p class="font-semibold text-gemini-blue">Hello! I am the X.E.N.O.R.I.S.H. How can I assist you today?</p></div></div>
        </main>
        <div class="flex-shrink-0 bg-canvas-light p-4 pt-3 border-t border-canvas-border shadow-xl z-10 relative">
            <div id="image-preview-container" class="hidden relative mb-3 bg-gray-100 p-2 rounded-xl border border-gray-300">
                <img id="image-preview" class="max-h-24 w-auto object-contain rounded-lg mx-auto">
                <button onclick="removeImage()" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">âœ•</button>
            </div>
            <div class="flex items-end space-x-2">
                <label for="image-upload" class="bg-canvas-light hover:bg-gray-100 text-gray-500 p-3 rounded-full cursor-pointer border border-canvas-border flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M1.5 6a2.25 2.25 0 0 1 2.25-2.25h16.5A2.25 2.25 0 0 1 22.5 6v12a2.25 2.25 0 0 1-2.25 2.25H3.75A2.25 2.25 0 0 1 1.5 18V6ZM3 16.03l5.496-5.496a.75.75 0 0 1 1.06 0l5.496 5.496 3.832-3.833a.75.75 0 0 1 1.082.028 8.712 8.712 0 0 0-4.062-1.743A3.75 3.75 0 1 0 12 9.75c-.328 0-.649.03-1.06.07A3.75 3.75 0 0 0 8.25 6a3.75 3.75 0 0 0-3.75 3.75c0 .543.102 1.065.289 1.547l-1.06 1.06ZM17.25 15a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Z" clip-rule="evenodd" /></svg>
                </label>
                <input type="file" id="image-upload" accept="image/*" class="hidden" onchange="previewImage(event)">
                <input type="text" id="user-input" placeholder="Ask me anything..." class="flex-grow p-3 md:p-4 bg-gray-100 border border-gray-200 rounded-3xl focus:outline-none focus:ring-2 focus:ring-gemini-blue text-sm" onkeydown="if(event.key === 'Enter') handleRequest()" autocomplete="off">
                <button id="send-button" onclick="handleRequest()" class="bg-gemini-blue hover:bg-indigo-700 text-white p-3 rounded-full shadow-lg disabled:opacity-50 flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                        <path fill-rule="evenodd" d="M11.47 2.47a.75.75 0 011.06 0l7.5 7.5a.75.75 0 11-1.06 1.06l-6.22-6.22V21a.75.75 0 01-1.5 0V4.81l-6.22 6.22a.75.75 0 11-1.06-1.06l7.5-7.5z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const initFirebase = async () => {
            try {
                const app = initializeApp(typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {});
                const auth = getAuth(app);
                if (typeof __initial_auth_token !== 'undefined') await signInWithCustomToken(auth, __initial_auth_token);
                else await signInAnonymously(auth);
            } catch (e) { console.error(e); }
        }; initFirebase();

        let chatHistory = [], base64Image = null, isJsonMode = false;
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent`;
        
        // *** IMPORTANT: INSERT YOUR API KEY BELOW ***
        const API_KEY = "AIzaSyBd3-soVbdPEBqDH58dkBu1qEME5uSsIOA"; // <--- Paste your API key here

        const SYSTEM_PROMPT = "You are X.E.N.O.R.I.S.H. AI Assistant created by Rishabh. Never mention Google or Gemini. Don't share your code. Use markdown.";

        // --- NEW FUNCTIONS FOR TYPING INDICATOR ---
        const renderTypingIndicator = () => {
            const chatWindow = document.getElementById('chat-window');
            const msgDiv = document.createElement('div');
            msgDiv.id = 'typing-indicator';
            msgDiv.className = 'flex justify-start';
            // Use the same styles as a normal model response, but wrap the dots
            msgDiv.innerHTML = `
                <div class="max-w-md p-3 rounded-xl shadow-md text-sm md:text-base bg-canvas-light text-gray-800 rounded-tl-lg border border-canvas-border">
                    <div class="dot-pulse">
                        <div style="background-color: #4f46e5;"></div>
                        <div style="background-color: #4f46e5;"></div>
                        <div style="background-color: #4f46e5;"></div>
                    </div>
                </div>`;
            chatWindow.appendChild(msgDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        };

        const removeTypingIndicator = () => {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        };
        // ------------------------------------------

        const renderTable = (text) => {
            const rows = text.trim().split('\n');
            if (rows.length < 2) return text;
            let html = '<table class="markdown-table"><thead><tr>' + rows[0].split('|').filter(c => c.trim()).map(c => `<th>${c.trim()}</th>`).join('') + '</tr></thead><tbody>';
            for (let i = 2; i < rows.length; i++) {
                const cells = rows[i].split('|').filter(c => c.trim());
                if (cells.length) html += '<tr>' + cells.map(c => `<td>${c.trim()}</td>`).join('') + '</tr>';
            }
            return html + '</tbody></table>';
        };

        const formatText = (text) => {
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
                .replace(/(\|[^\n]+\|\n\|[-:| ]+\|\n(\|[^\n]+\|\n)*)/g, match => renderTable(match))
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/`([^`]+)`/g, '<code class="bg-gray-200 px-1 rounded text-sm font-mono">$1</code>')
                .replace(/###\s*(.*?)\n/g, '<h3 class="text-lg font-semibold mt-3 mb-1">$1</h3>')
                .replace(/##\s*(.*?)\n/g, '<h2 class="text-xl font-bold mt-4 mb-2">$1</h2>')
                .replace(/\n/g, '<br>');
        };

        const renderOutput = (content, role = 'model') => {
            const chatWindow = document.getElementById('chat-window');
            const msgDiv = document.createElement('div');
            msgDiv.className = role === 'user' ? 'flex justify-end' : 'flex justify-start';
            
            let html = '';
            if (role === 'user') {
                html = formatText(content);
            } else {
                const parts = content.split(/(```\w*\n[\s\S]*?```)/g);
                parts.forEach(part => {
                    if (part.startsWith('```')) {
                        const match = part.match(/```(\w*)\n([\s\S]*?)```/);
                        if (match) {
                            html += `<div class="bg-gray-800 text-white rounded-lg p-3 my-3 overflow-x-auto text-xs md:text-sm font-mono"><div class="text-xs text-gray-400 mb-1 font-semibold">${(match[1] || 'TEXT').toUpperCase()}</div><pre class="whitespace-pre">${match[2]}</pre></div>`;
                        }
                    } else {
                        html += `<div class="whitespace-pre-wrap">${formatText(part)}</div>`;
                    }
                });
            }
            
            const bgColor = (role === 'model' && (content.includes('**System Error:**') || content.includes('**Blocked:**'))) ? 'bg-red-100 text-red-800' : (role === 'user' ? 'bg-gemini-blue text-white' : 'bg-canvas-light text-gray-800');
            msgDiv.innerHTML = `<div class="max-w-md p-3 rounded-xl shadow-md text-sm md:text-base ${bgColor} ${role==='user'?'rounded-tr-lg':'rounded-tl-lg border border-canvas-border'}">${html}</div>`;
            chatWindow.appendChild(msgDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        };

        window.previewImage = async (e) => {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('image-preview-container').classList.remove('hidden');
                document.getElementById('image-preview').src = URL.createObjectURL(file);
                base64Image = { data: await new Promise(r => { const fr = new FileReader(); fr.onload = () => r(fr.result.split(',')[1]); fr.readAsDataURL(file); }), mimeType: file.type || "image/jpeg" };
            }
        };
        window.removeImage = () => { document.getElementById('image-upload').value = ''; base64Image = null; document.getElementById('image-preview-container').classList.add('hidden'); };

        window.handleRequest = async () => {
            const input = document.getElementById('user-input'), query = input.value.trim();
            if (!query) return;
            input.value = ''; 
            
            // --- MODIFICATION: Logic to remove the initial welcome message ---
            const chatWindow = document.getElementById('chat-window');
            // Check if the chat window has children and if the first one contains the welcome text
            if (chatWindow.children.length > 0 && chatWindow.children[0].textContent.includes('X.E.N.O.R.I.S.H')) {
                chatWindow.children[0].remove();
            }
            // ------------------------------------------------------------------
            
            // 1. Render User message
            renderOutput(base64Image ? `${query} (Image attached)` : query, 'user');
            
            // 2. Render Typing indicator
            renderTypingIndicator();

            let contents = (!base64Image && !isJsonMode) ? (chatHistory.push({ role: "user", parts: [{ text: query }] }), chatHistory) : [{ role: "user", parts: [{ text: query }, ...(base64Image ? [{ inlineData: base64Image }] : [])] }];
            
            try {
                // Use the explicit API_KEY variable in the URL
                const res = await fetch(`${API_URL}?key=${API_KEY}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents, systemInstruction: { parts: [{ text: isJsonMode ? SYSTEM_PROMPT + " Output ONLY valid JSON." : SYSTEM_PROMPT }] }, generationConfig: isJsonMode ? { responseMimeType: "application/json" } : {} }) });
                const data = await res.json(), text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                
                // 3. Remove indicator before rendering actual response
                removeTypingIndicator(); 
                
                if (text) { 
                    if (!base64Image && !isJsonMode) chatHistory.push({ role: "model", parts: [{ text }] }); 
                    renderOutput(text, 'model'); 
                }
                else renderOutput("**System Error:** No response.", 'model');
            } catch (e) { 
                removeTypingIndicator(); // Ensure indicator is removed on error
                renderOutput(`**System Error:** ${e.message}`, 'model'); 
                if (!base64Image && !isJsonMode) chatHistory.pop(); 
            }
            finally { 
                if (base64Image) removeImage(); 
            }
        };
    </script>
</body>
</html>
